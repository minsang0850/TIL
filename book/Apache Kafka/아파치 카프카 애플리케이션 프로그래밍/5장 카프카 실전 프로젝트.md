## 웹 페이지 이벤트 적재 파이프라인 생성
웹 페이지의 사용자 이벤트 수집은 서비스에 영향을 미치지 않으면서도 안정적으로 유지되어야 한다.

따라서 이벤트 수집 파이프라인과 서비스의 커플링을 최소화하고 확장설 높은 파이프라인을 만드는 것이 중요하다.

갑자기 이벤트가 많이 발생하더라도 발생한 이벤트들은 모두 카프카의 토픽에 쌓인다.
그 다음은 간단하다.
컨슈머는 자신이 할 수 있는 양만큼 최종 적재 애플리케이션에 저장하면 되기 때문이다.

### 요구 사항
이름을 입력하고, 자신이 좋아하는 색상을 고르는 버튼을 누르면 해당 이벤트와 유저 에이전트 정보를 카프카 토픽으로 전달하고 최종적으로 하둡과 엘라스틱서치에 적재되는 것을 목표로 한다.

하둡은 대용량 데이터를 분 처리할 수 있다.

엘라스틱 서치는 오픈소스 분산 검색 엔진이다.

### 정책 및 기능 정의
**적재 정책**  
0.11.0.0 이전 버전의 카프카는 적어도 한번 이상(at least once) 전달을 만족.
이후 버전부터는 멱등성 프로듀서를 통해 정확히 한번 전달(프로듀서->브로커)을 지원

정확히 한번 전달되더라도 정확히 한번 적재는 되지 않을 수 있다.
왜냐하면 컨슈머의 커밋 시점과 데이터 적재가 동일 트랜잭션에서 처리되어야 정확히 한번 적재될 수 있기 때문이다.

정확히 한번 적재가 필요할 경우에는 멱등성 프로듀서를 사용하고 고유한 키를 지원하는 데이터베이스 시스템에 적재하는 것이 가장 확실하다.

**데이터 포맷**  
데이터 포맷을 선택할 때 두 가지를 우선적으로 생각해 볼 수 있다.
- 스키마 변화의 유연성
- 명령어를 통한 디버깅의 편리성

-> 보통 JSON

**프로듀서**  
웹 페이지에서 생성된 이벤트를 받는 REST API 클라이언트를 만들고 전달받은 이벤트를 가공하여 토픽으로 전달하는 역할을 한다.

프로듀서를 운영할 때 가장 처음 고민해야 할 옵션은 ack를 어떤 값으로 설정할지다.

- all: 네트워크 이상에 복구할 확률은 높지만 성능이 떨어짐.
- 1 or 0: 속도는 빠르지만 데이터 유실이 발생할 수 있다.

최소 동기화 리플리카(min.insync.replicas)설정: ack을 1로 선태갛ㄴ 경우는 설정을 무시하고 리더 파티션에 지속 적재하므로 따로 설정할 필요가 없다.

**파티셔너 설정**  
파티셔너를 활용하면 메시지 키 또는 메시지 값을 기반으로 어떤 파티션으로 전달될지 결정하는 로직을 적용할 수 있다.
그러나 웹 페이지에서 생성된 데이터는 특별히 파티션을 분류할 필요가 없기 때문에 프로듀서에 설저앟ㄹ 파티셔너는 기본 파티셔너를 사용한다.

**재시도 설정**  
토픽의 데이터 순서를 지키지 않고 중복을 허용하기 때문에 기본값을 사용한다.

**토픽**  
파티션 개수:이벤트 발생 시간을 데이터에 같이 조합해서 보내면 적재 순서가 이벤트 발생 순서가 달라도 되기 때문에 파티션을 여러 개로 생성하여 병렬로 컨슈머를 운영해도 된다는 뜻이다.
-> 2개 이상

메시지 키의 사용 여부: 키를 사용하고 커스텀 파티셔너를 사용하지 않으면 키의 해시 값으로 파티션이 분배된다. 파티션이 증가되면 매칭이 깨지므로 곤란해질 수 있다.
-> 키 사용 X

복제 개수: 최소 설정 2

**컨슈머** 
두 가지 방법
- 컨슈머 API를 사용하여 직접 애플리케이션을 개발
- 커넥트를 사용

### 기능 구현
**하둡 적재 컨슈머 애플리케이션 개발**  
데이터를 저장하는 방식은 크게 두 가지
- append: 파일이 없으면 파일을 생성하고 poll()로 받은 데이터를 파일에 추가.
  - 파일 개수를 늘리지 않고 계쏙 데이터 추가
  - 기존 데이터에 문제가 생기면 더는 append 할 수 없다.
- flush
  - 버퍼에 일정 기간 데이터를 쌓고 한번에 저장
  - 버퍼용 메모리가 필요하고, 파일 개수가 늘어난다는 단점

컨슈머 멀티 스레드 환경은 동일 데이터의 동시 접근에 유의해야 한다.
여러 개의 컨슈머가 동일한 HDFS 파일에 접근을 시도한다면 교착 상태(deadlock)에 빠질 수 있는 위험이 있기 때문.

멀티스레드로 동작하는 HDFS 적재 컨슈머 코드
- poll() 메서드 호출
- HDFS 적재 로직
- 셧다운 로직

**엘라스틱서치 싱크 커넥터 개발**   
커넥터는 템플릿처럼 재사용성을 높이는 데에 중점을 둔다.  
예를 들어 동일 토픽을 서로 다른 엘라스틱 서치 클러스터에 넣고 싶다면 엘라스틱서치 클러스터별 커넥터를 개발하는 것이 아니라 설정을 통해 타깃 클러스터를 변경하는 것이다.

### 기능 테스트
- REST 프로듀서 실행
- 하둡 적재 컨슈머 실행
- 분산 모드 카프카 커넥트 실행
- 엘라스틱서치 싱크 커넥터 실행
- 웹 페이지 실행 및 웹 이벤트 발생

### 상용 인프라 아키텍처
최소한으로 웹 이벤트 수집 파이프라인 구축
- L4 로드밸런서: 웹 이벤트를 받아서 프로듀서로 분배 역할
- 프로듀서: 2개 이상의 서버, 각 서버당 1개 프로듀서
- 카프카 클러스터: 3개 이상의 브로커로 구성
- 컨슈머: 2개 이상의 서버, 각 서버당 1개 컨슈머
- 커넥트: 2개 이상의 서버, 분산 모드 커넥트로 구성

웹 이벤트가 지속저긍로 늘어날 경우 파티션 개수를 늘려서 대응.
파티션 개수, 컨슈머 스레드 개수, 커넥트 태스크 개수를 증가시키면 병렬 처리를 증가시킬 수 있음.
 


