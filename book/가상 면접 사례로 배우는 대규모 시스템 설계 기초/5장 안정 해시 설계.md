## 해시 키 재배치(rehash) 문제
serverIndex = hash(key) % N (N은 서버의 개수이다.)
이 방법은 서버 풀(server pool)의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 떄는 잘 동작한다.
하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.

## 안정 해시
안정 해시(consistent hash)는 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다.
여기서 k는 키의 개수이고, n은 슬롯(slot)의 개수다. 
이와는 달리 대부분의 전통적 해시 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치한다.

### 해시 공간과 해시 링
**여기부터는 책의 그림을 보는 것이 좋다.**  

해시 함수 f로는 SHA-1을 사용한다고 하고, 그 함수의 출력 값 범위는 x0, x1, x2, ... xn과 같다고 하자.
SHA-1의 해시 공간(hash space) 범위는 0부터 2<sup>160</sup>-1 까지라고 알려져 있다.
따라서 x0는 0, xn은 2<sup>160</sup>-1 이며, 나머지 x1부터 xn-1까지는 그 사이의 값을 갖게 될 것이다.

### 해시 서버
해시 함수 f를 사용하면 서버 IP나 이름을 링 위의 어떤 위치에 대응시킬 수 있따.

### 해시 키

### 서버 조회
어떤 키가 저장되는 서버는, 해당 키의 위치로부터 시계 방향으로 링을 탐색해나가면서 만나는 첫 번째 서버다.

### 서버 추가
서버를 추가하더라도 키 가운데 일부만 재배치하면 된다.

### 서버 제거
하나의 서버가 제거되면 키 가운데 일부만 재배치된다.

### 기본 구현법의 두 가지 문제
안정 해시 알고리즘은 MIT에서 처음 제안되었다. 그 기본 절차는 다음과 같다.
- 서버와 키를 균등 분포(uniform distribution) 해시 함수를 사용해 해시 링에 배치한다.
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버다.

이 접근 법에는 두 가지 문제가 있따.
서버가 추가되거나 삭제되는 상황을 감안하면 파티션(partition)의 크기를 균등하게 유지하는게 불가능하다는 것이 첫 번째 문제다.
여기서 파티션은 인접한 서버 사이의 해시 공간이다.
어떤 서버는 굉장히 작은 해시 공간을 할당 받고, 어떤 서버는 굉장히 큰 해시 공간을 할당 받는 상황이 가능하다는 것이다.

두 번째 문제는 키의 균등 분포(uniform distribution)를 달성하기가 어렵다는 것이다.

이 문제를 해결하기 위해 제안된 기법이 가상 노드(virtual node) 또는 복제(replica)라 불리는 기법이다.

### 가상 노드
가상 노드(virtual node)는 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
서버들은 n개의 가상 노드를 갖는다.
키의 위치로부터 시계 방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버가 된다.
가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다.
100~200개의 가상 노드를 사용했을 경우 표준 편차 값은 평균의 5% 사이다.

가상 노드 개수를 늘리면 표준 편차의 값은 더 떨어지지만 가상 노드 데이터를 저장할 공간은 더 많이 필요하게 될 것이다.
타협적 결정(tradeoff)이 필요하다는 뜻이다.

### 재배치할 키 결정
서버가 추가되거나 제거되면 데이터 일부는 재배치해야 한다. 어느 범위의 키들이 재배치되어야 할까? -> 그림 참조

## 마치며
**안정 해시의 이점**
- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟(hotspot) 키 문제를 줄인다. 특정한 샤드(shard)에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있다.