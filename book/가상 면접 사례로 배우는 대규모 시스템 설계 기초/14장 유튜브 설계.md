# 비디오 플랫폼 설계
- 월간 능동 사용자 수: 20억
- 매일 재생되는 비디오 수: 50억
- 미국 성인 가운데 73%가 유튜브 이용
- 5000만명의 창작자
- 유튜브 광고 수입은 2019년 기준으로 150억 달러이며 이는 2018년도 대비 36% 증가한 수치
- 모바일 인터넷 트래픽 가운데 37%를 유튜브가 점유
- 80개 언어로 이용 가능

## 1단계 문제 이해 및 설계 범위 확정
- 지원자: 어떤 기능이 가장 중요한가요?
- 면접관: 비디오를 올리는 기능과 시청하는 기능입니다.
- 지원자: 어떤 클라이언트를 지원해야 하나요?
- 면접관: 모바일 앱, 웹 브라우저, 그리고 스마트 TV 입니다.
- 지원자: 일간 능동 사용자 수는 몇 명입니까?
- 면접관: 500만입니다.
- 지원자: 사용자가 이 제품에 평균적으로 소비하는 시간은 얼마인가요?
- 면접관: 30분입니다.
- 지원자: 다국어 지원이 필요한가요?
- 면접관: 어떤 언어로도 이용 가능해야 합니다.
- 지원자: 어떤 비디오 해상도를 지원해야 할까요?
- 면접관: 현존하는 비디오 종류와 해상도를 대부분 지원해야 합니다.
- 지원자: 암호화가 필요할까요?
- 면접관: 네
- 지원자: 비디오 파일 크기에 제한이 있습니까?
- 면접관: 작은 비디오, 혹은 중간 크기 비디오에 초점을 맞추도록 합시다. 비디오 크기는 최대 1GB로 제한합니다.
- 지원자: 아마존이나 구글, 마이크로소프트가 제공하는 클라우드 서비스를 활용해도 될까요?
- 면접관: 좋은 질문입니다. 모든 걸 바닥부터 쌓아 올리는 것은 대부분 회사에게는 비현실적인 일이죠.
활용할 수 있다면 하는 것이 바람직할 것입니다.

**초점**  
- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용(infrastructure cost)
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트: 모바일 앱, 웹브라우저, 그리고 스마트 TV

### 개략적 규모 측정
- DAU: 500만
- 한 사용자는 하루에 평균 5개의 비디오를 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량=500만 * 10% * 300MB = 150TB
- CDN 비용
  - 클라우드 CDN을 통해 비디오를 서비스할 경우 CDN에서 나가는 데이터의 양에 따라 과금한다.
  - 아마존의 클라우드프론트를 CDN 솔루션으로 사용할 경우, 100% 트래픽이 미국에서 발생한다고 가정하면 1GB당 $0.02의 요금이 발생한다.
  문제를 단순화하기 위해 비디오 스트리밍 비용만 따지도록 하겠다.
  - 따라서 매일 발생하는 요금은 500만 * 5비디오 % 0.3GB * $0.02 = $150,000 이다.

## 2단계 개략적 설계안 제시 및 동의 구하기
CDN과 BLOB 스토리지의 경우에는 기존 클라우드 서비스를 활용할 것이다.

**직접 만드지 않는 이유**  
- 시스템 설계 면접은 모든 것을 밑바닥부터 만드는 것과는 관계가 없다. 
주어진 시간 안에 적절한 기술을 골라 설계를 마치는 것이, 그 기술 각각이 어떻게 동작하는지 상세히 설명하는 것보다 중요하다.
- 규모 확장이 쉬운 BLOB 저장소나 CDN을 만드는 것은 지극히 복잡할 뿐 아니라 많은 비용이 드는 일이다.

### 비디오 업로드 절차
![img.png](images/비디오%20업로드%20절차.png)
- 메타데이터 데이터베이스 (metadata db): 비디오의 메타데이터를 보관한다.
샤딩(sharding)과 다중화(replication)을 적용하여 성능 및 가용성 요구사항을 충족한다.
- 메타데이터 캐시(metadata cache): 성능을 높이기 위해 비디오 메타데이터와 사용자 객체(user object)는 캐시한다.
- 원본 저장소(original storage): 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB, Binary Large Object Storage) 시스템이다.
BLOB 저장소는 "이진 데이터를 하나의 개체로 보관하는 데이터베이스 관리 시스템"이다.
- 트랜스코딩 서버(transcoding server): 비디오 트랜스코딩은 비디오 인코딩이라 부르기도 하는 절차로,
비디오의 포맷(MPEG, HLS 등)을 변환하는 절차다.
단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- 트랜스코딩 비디오 저장소(transcoded storage): 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소다.
- CDN: 비디오를 캐시하는 역할을 담당한다.
- 트랜스코딩 완료 큐(completion queue): 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐다.
- 트랜스코딩 완료 핸들러(completion handler): 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들이다.

### 프로세스 a: 비디오 업로드
1. 비디오를 원본 저장소에 업로드한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스코딩이 완료되면 아래 두 절차가 병렬적으로 수행된다.
   1. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드한다.
   2. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
      1. 트랜스코딩이 끝난 비디올르 CDN에 올린다.
      2. 완료 해들러가 이벤트 데이터를 큐에서 꺼낸다.
      3. 완료 핸들러가 메타데이터 데이터베이스와 캐시를 갱신한다.
4. API 서버가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 되었음을 알린다.

### 프로세스 b: 메타데이터 갱신
우너본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.

### 비디오 스트리밍 절차
**스트리밍 프로토콜(streaming protocol)**  
비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법이다.
- MPEG-DASH. MPEG은 "Moving Picture Experts Group"의 약어이며, DASH는 "Dynamic Adaptive Streming over HTTP"의 약어다.
- 애플 HLS. HLS는 "HTTP Live Streaming"의 약어다.
- 마이크로소프트 스무드 스트리밍(Microsoft Smmoth Streaming)
- 어도비 HTTP 동적 스트리밍(Adobe HTTP Dynamic Streaming, HDS)

프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다.

비디오는 CDN에서 바로 스트리밍 된다.
사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당할 것이다.
따라서 전송지연은 아주 낮다.

## 3단계 상세 설계
### 비디오 트랜스코딩
비디오를 녹화하면 단말은 해당 비디오를 특정 포맷으로 저장한다.
이 비디오가 다른 단말에서도 순조롭게 재생되려면 다른 단말과 호환되는 비트레이트(bitrate)와 포맷으로 저장되어야 한다.
비트레이트는 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위다.

**비디오 트랜스코딩의 중요성**  
- 가공되지 않은 원본 비디오(raw video)는 저장 공간을 많이 차지한다. 
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다.
- 사용자에게 끊김 없는 고화질 비디오 재생을 보장하려면, 네트워크 대역폭이 충분하지 않은 사용자에게는 저화질 비디오를,
대역폭이 충분한 사용자에게는 고화질 비디오를 보내는 것이 바람직하다.
- 모바일 단말의 경우 네트워크 상황이 수시로 달라질 수 있다. 
비디오가 끊김 없이 재생되도록 하기 위해서는 비디오 화질을 자동으로 변경하거나 수동으로 변경할 수 있도록 하는 것이 바람직하다.

**인코딩 포맷**
- 컨테이너(container): 비디오 파일, 오디오, 메타데이터를 담는 바구니 같은 것이다.
- 코덱(codec): 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘이다.

### 유향 비순환 그래프(DAG) 모델
각기 다른 유형의 비디오 프로세싱 파이프라인을 지원하는 한편 처리 과정의 병렬성을 높이기 위해서는 적절한 수준의 추상화를 도입하여 클라이언트 프로그래머로 하여금 실행할 작업을 손수 정의할 수 있도록 해야 한다.
예를 들어 페이스북의 스트리밍 비디오 엔진은 유향 비순환 그래프 프로그래밍 모델을 도입, 
작업을 단계별로 배열할 수 있도록 하여 해당 작업들이 순차적으로 또는 병렬적으로 실행될 수 있도록 하고 있다.

![img.png](images/DAG%20모델%20설계안.png)

원본 비디오는 비디오, 오디오, 메타데이터의 세 부분으로 나뉘어 처리된다.

**비디오 작업**  
- 검사
- 비디오 인코딩
- 섬네일
- 워터마크

### 비디오 트랜스코딩 아키텍처
![img.png](images/비디오%20트랜스코딩%20아키텍처.png)
**전처리기**  
- 비디오 분할: 비디오 스트림을 GOP(Group of Pictures)라고 불리는 단위로 쪼갠다. 
GOP는 특정 순서로 배열된 프레임 그룹이다. 하나의 GOP는 독립적으로 재생 가능하며, 길이는 보통 몇 초 정도다.
- DAG 생성: 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어 낸다.
- 데이터 캐시

### DAG 스케줄러
DAG 스케줄러는 DAG 그래프를 몇 개 단계(stage)로 분할한 다음에 그 각각을 자원 관리자의 작업 큐(task queue)에 집어넣는다.
![img.png](images/DAG%20스케줄러.png)

### 자원 관리자
자원 배분을 효과적으로 수행하는 역할을 담당한다.
- 작업 큐(task queue): 실행할 작업이 보관되어 있는 우선순위 큐이다.
- 작업 서버 큐: 작업 서버의 가용 상태 정보가 보관되어 있는 우선순위 큐이다.
- 실행 큐: 현재 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 큐다.
- 작업 스케줄러: 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업을 수행하도록 지시하는 역할을 담당한다.

### 작업 서버
DAG에 정의된 작업을 수행한다.

### 임시 저장소
- 메타데이터는 작업 서버가 빈번히 참조하는 정보이고, 그 크기도 작으므로 메모리에 캐시
- 비디오/오디오 데아터는 BLOB 저장소에 두는 것이 바람직

### 시스템 최적화
**속도 최적화: 비디오 병렬 업로드**  
GOP를 분할해서 병렬적 업로드

**속도 최적화: 업로드 센터를 사용자 근거리에 지정**  

**속도 최적화: 모든 절차를 병렬화**  
메시지 큐를 도입해서 인코딩 모듈은 다운로드 모듈의 작업이 끝나기를 더 이상 기다릴 필요가 없다.
메시지 큐에 보관된 이벤트 각각을 인코딩 모듈은 병렬적으로 처리할 수 있다.

**안정성 최적화: 미리 사인된 업로드 URL**  
허가받은 사용자만이 올바른 장소에 비디오를 업로드할 수 있도록 하기 위해,
미리 사인된(pre-signed) 업로드 URL을 이용한다.

**업로드 절차**
1. 클라이언트는 HTTP 서버에 POST 요청을 하여 미리 사인된 URL을 받는다.
2. API서버는 미리 사인된 URL을 돌려준다.
3. 클라이언트는 해당 URL이 가리키는 위치에 비디오를 업로드하다.

**안전성 최적화: 비디오 보호**  
- 디자털 저작권 관리(DRM: Digital Rights Management) 시스템 도입
- AES 암호화: 재생시에만 복호화
- 워터마크

**비용 최적화**  
유튜브의 비디오 스트리밍은 롱테일 분포를 따른ㄹ다.
- 인기 비디오는 CDN을 통해 재생하되 다른 비디오는 비디오 서버를 통해 재생하는 것이다.
- 인기가 별로 없는 비디오는 인코딩 할 필요가 없을 수도 있다. 짧은 비디오라면 필요할 때 인코딩하여 재생할 수 있다.
- 어떤 비디오는 특정 지역에섬나 인기가 높다.
- CDN을 직접 구축하고 인터넷 서비스 제공자와 제휴한다.

### 오류 처리
- 회복 가능 오류(recoverable error): 특정 비디오 세그먼트를 트랜스코딩하는데 실패했다던가 하는 문제. 리트라이로 해결 가능.
- 회복 불가능 오류(non-recoverable error): 비디오 포맷이 잘못되었다거나 하는 회복 불가능한 오류가 발견되면 시스템은 해당 비디오에 대한 작업을 중단하고 클라이언트에게 적절한 오류 코드를 반환해야 한다.

## 4단계 마무리
**추가 논의점**
- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- 라이브 스트리밍
- 비디오 삭제
