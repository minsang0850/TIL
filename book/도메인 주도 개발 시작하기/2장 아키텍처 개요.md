# 2.1 네 개의 영역
스프링 MVC 프레임워크가 표현 영역을 위한 기술에 해당한다.
표현 영역의 사용자는 웹 브라우저를 사용하는 사람일 수도, REST API를 호출하는 외부 시스템일 수도 있다.

우베 애플리케이션의 표현 영역은 HTTP 요청을 응용 영역이 필요로 하는 형식으로 변환해서 응용 영역에 전달하고 응용 영역의 응답을 HTTP 응답으로 변환하여 전송한다.

응용 영역은 시스템이 사용자에게 제공해야 할 기능을 구현한다.
응용 영역은 직접 로직을 수행하기보다는 도메인 모델에 로직 수행을 위임한다.

도메인 영역은 도메일 모델을 구현한다. Order, OrderLine 등이 이 영역에 위치한다.
도메인의 핵심 로직을 구현한다.

인프라스트럭처 영역은 구현 기술에 대한 것을 다룬다.
RDBMS 연동을 처리하고, MQ에 메시지를 전송하거나 수신하는 기능을 구현한다.
인프라스트럭처 영역은 논리적인 개념을 표현하기보다는 실제 구현을 다룬다.

# 2.2 계층 구조 아키텍처
표현 -> 응용 -> 도메인 -> 인프라 스트럭처

계층 구조는 상위 계층에서 하위 계층으로의 의존만 존재한다.
계층 구조를 엄격하게 적용한다면 상위 계층은 바로 아래의 계층에만 의존을 가져야 하지만 구현의 편리함을 위해 계층 구조를 유연하게 적용하기도 한다.

표현, 응용, 도메인 계층이 상세한 구현 기술을 다루는 인프라스트럭처에 종속된다.

응용 영역에서 인프라스트럭처를 사용하면 두 가지 문제를 안게된다.
1. 응용 계층만 테스트하기 어렵다.
2. 구현 방식을 변경하기 어렵다.

인프라스트럭처에 의존하면 '테스트 어려움', '기능 확장의 어려움' 두 가지 문제가 발생한다.

# 2.3 DIP
CalculateDiscountService는 고수준 모듈이다. 고수준 모듈은 의미 있는 단일 기능('가격 할인 계산')을 제공하는 모듈이다.
고수준 모듈의 기능을 구현하려면 여러 하위 기능(고객 정보를 구하고, 룰을 실행한다)이 필요하다.

고수준 모듈이 제대로 동작하려면 저수준 모듈에 의존해야하지만 이렇게 되면 구현 변경과 테스트가 어렵다는 문제가 발생한다.

DIP는 이 문제를 해결하기 위해 저수준 모듈이 고수준 모듈에 의존하도록 바꾼다.
저수준 모듈이 아닌 "룰을 이용한 할인 금액 계산"을 추상화한 RuleDiscounter 인터페이스에 의존한다.

고수준 모듈이 저수준 모듈을 사용하려면 고수준 모듈이 저수준 모듈에 의존해야 하는데, 반대로 저수준 모듈이 고수준 모듈에 의존한다고 해서 이를 DIP, 의존 역전 원칙이라고 부른다.

RuleDiscounter는 인터페이스이므로 Mock 객체를 사용해서 테스트를 쉽게 진행할 수 있다.

## 2.3.1 DIP 주의사항
DIP를 적용할 떄 하위 기능을 추상화한 인터페이스는 고수준 모듈 관점에서 도출한다.

## 2.3.2 DIP와 아키텍처
고수준 모듈 -> 저수준 모듈 의존을 최소화. 그러나 아예 없애긴 쉽지 않음.

# 2.4 도메인 영역의 주요 구성요소
**도메인 영역을 구성하는 요소**
- 엔티티(ENTITY): 고유한 식별자를 갖는 객체로 자신의 라이프 사이클을 갖는다.
- 밸류(VALUE): 개념적인 하나의 값을 표현할 때 사용된다. (주소, 금액)
- 애그리거트(AGGREGATE): 애그리거트는 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다.
- 리포지토리(REPOSITORY): 도메인 모델의 영속성을 처리한다.
- 도메인 서비스(DOMAIN SERVICE): 특정 엔티티에 속하지 않은 도메인 로직을 제공한다.

## 2.4.1 엔티티와 밸류
도메인 모델의 엔티티와 DB모델의 엔티티는 다르다.
두 모델의 가장 큰 차이점은 도메인 모델의 엔티티는 데이터와 함께 도메인 기능을 함께 제공한다는 점이다.

도메인 모델의 엔티티는 단순히 데이터를 담고 있는 데이터 구조라기보다는 데이터와 함께 기능을 제공하는 객체이다.
도메인 관점에서 기능을 구현하고 기능 구현을 캡슐화해서 데이터가 임의로 변경되는 것을 막는다.

또 다른 차이점은 도메인 모델의 엔티티는 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입을 이용해서 표현할 수 있다는 것이다.

## 2.4.2 애그리거트
도메인 모델도 개별 객체뿐만 아니라 상위 수준에서 모델을 볼 수 있어야 전체 모델의 관계와 개별 모델을 이해하는 데 도움이 된다.
도메인 모델에서 전체 구조를 이해하는 데 도움이 되는 것이 바로 애그리거트이다.

애그리거트는 관련 객체를 하나로 묶은 군집이다.
애그리거트의 대표적 예가 주문이다. 주문이라는 도메인 개념은 '주문', '배송지 정보', '주문자', '주문 목록', '총 결제 목록'의 하위 모델로 구성된다.
이 하위 개념을 표현한 모델을 하나로 묶어서 주문이라는 상위 개념으로 표현할 수 있다.

애그리거트를 사용하면 개별 객체가 아닌 관련 객체를 묶어서 객체 군집 단위로 모델을 바라볼 수 있게 된다.
개별 객체 간의 관계가 아닌 애그리거트 간의 관계로 도메인 모델을 이해하고 구현하게 되며, 이를 통해 큰 틀에서 도메인 모델을 관리할 수 있다.

애그리거트는 군집에 속한 객체를 관리하는 루트 엔티티를 갖는다.
루트 엔티티는 애그리거트에 속해 있는 엔티티와 밸류 객체를 이용해서 애그리거트가 구현해야 할 기능을 제공한다.
애그리거트를 사용하는 코드는 애그리거트 루트가 제공하는 기능을 실행하고 애그리거트 루트를 통해서 간접적으로 애그리거트 내의 다른 엔티티나 밸류 객체에 접근한다.

## 2.4.3 리포지터리
도메인 객체를 지속적으로 사용하려면 RDBMS, NoSQL 같은 물리적인 저장소에 도메인 객체를 보관해야한다. 이를 위한 도메인 모델이 리포지터리이다.

엔티티나 밸류가 요구사항에서 도출되는 도메인 모델이라면 리포지터리는 구현을 위한 도메인 모델이다.

리포지터리는 애그리거트 단위로 도메인 객체를 저장하고 조회하는 기능을 정의한다.

도메인 모델 관점에서 Repository는 도메인 객체를 영속화하는 데 필요한 기능을 추상화한 것으로 고수준 모듈에 속한다.
기반 기술을 이용해서 OrderRepository를 구현한 클래스는 저수준 모듈로 인프라스트럭처 영역에 속한다.

응용 서비스와 리포지터리는 밀접한 연관이 있다.
- 응용 서비스는 필요한 도메인 객체를 구하거나 저장할 때 리포지터리를 사용한다.
- 응용 서비스는 트랙잭션을 관리하는데, 트랜잭션 처리는 리포지터리 구현 기술의 영향을 받는다.

리포지터리를 사용하는 주체가 응용 서비스이기 때문에 리포지터리는 응용 서비스가 필요로 하는 메서드를 제공한다.
- 애그리거트를 저장하는 메서드
- 애그리거트 루트 식별자로 애그리거트를 조회하는 메서드
- 기타등등

# 2.5 요청 처리 흐름

# 2.6 인프라스트럭처 개요
도메인 객체의 영속성 처리, 트랜잭션, SMTP 클라이언트, REST 클라이언트 등 다른 영역에서 필요로 하는 프레임워크, 구현 기술, 보조 기능을 지원한다.

DIP에서 언급한 것처럼 도메인 영역과 응용 영역에서 인프라스트럭처의 기능을 직접 사용하는 것보다 이 두 영역에 정의한 인터페이스를 인프라스트럭처 영역에서 구현하는 것이 시스템을 더 유연하고 테스트하기 쉽게 만들어준다.

하지만 무조건 인프라스트럭처에 대한 의존을 없앨 필요는 없다. 스프링이 제공하는 @Transactional 같은 것을 사용하는 것은 편리하다.

# 2.7 모듈 구성
모듈 구조를 얼마나 세분화해야 하는지에 대한 규칙은 없다. 하지만 보통 10~15개 미만으로 타입 개수를 유지하려고 노력한다.
