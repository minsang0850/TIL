https://www.youtube.com/watch?v=MTSn93rNPPE&t=710s

### 주문 Flow
주문 준비, 주문 지면, 결제 요청, 결제 완료

3000 RPM -> 470,000 RPM => 150배 트래픽이 들어옴

트래픽이 back단에 모든 서버에 장애로 전파될 수 있음.

모든 트래픽을 처리할 수 있을만큼씩 들여보내자!

### 큐 시스템
- 기능
  - 모든 이벤트 대상에게 번호표 발급
  - 번호표를 발급바등ㄴ 사용자를 줄을 세운다(대기열)
  - 대기열의 사용자에게 현재 몇번째 대기순서를 알려줌
  - 서버가 소화할 수 있을 만큼 사용자를 입장(참가열)
- 고려사항
  - 고성능 처리 가능 (Redis)

### Why Redis?
- 많은 서비스에서 사용하는 검증된 저장소
- 입/출력이 빠른 In-Memory DB
- 다양한 자료구조 지원, 요구사항을 쉽게 해결 가능

### 대기열
- 이벤트 주문을 요청한 순서대로 처리
  - ZADD - 데이터 추가시 부여한 스코어(타임스탬프)에 따라 정렬
- 대기중인 사용자에게 현재 대기순번을 제공
  - ZRANK - 현재 순위 조회
- 일정한 수만큼 대기열 > 참가열 이동
  - ZRANGE - 일정한 수만큼 리스트 조회

### 레디스 사용시 고려사항
- KEYS 명령어 사용 금지
  - 풀스캔, 시간복잡도 O(n)
  - 싱글스레드
- 각 명령어의 시간복잡도 확인
  - Sorted Set의 경우 시간복잡도 O(log(n))
  - 데이터가 많아질수록 성능 저하

### 큐 시스템 플로우
1. 주문 요청
2. 대기번호 발급
3. 참가열 진입까지 대기 (Polling)
4. 프로모션 스케줄러가 1초마다 설정된 값만큼 **대기열 -> 참가열** 이동
5. 참가열로 들어가게 되면 기존 주문 플로우를 탐

10배든 100배든 늘어난 트래픽이 들어오면 큐 시스템이 대량 트래픽을 소화

중간에 어떻게 끼워넣지?

**주문 라우터**
- 주문 시스템으로 요청이 들어오는 출입구
- RULE에 따라 API HOST를 변경할 수 있는 라우팅 서버
- RULE은 회원번호, 업소번호, 지역코드로 설정
- WebFlux + Netty 논블로킹 서버.
- 10000 TPS 거뜬히 처리

일반 사용자 -> 기존 시스템
쿠폰발급 + 이벤트 업소 -> 큐 시스템


