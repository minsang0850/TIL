https://www.youtube.com/watch?v=v9rcKpUZw4o&list=WL&index=4&t=8s

## 은행 시스템의 구조
- 채널계(유저의 요청을 직접 받아 처리)
  - K8s 위에서 동작
  - 여러 서버로 구성
  - 특정 서버만 스케일 아웃, DB 분리 가능
  - 큰 트래픽 다루는 데에 능함
- 계정계(돈을 직접 다룸, 아주 높은 신뢰도)
  - 서버, DB 하나씩
  - 급증하는 트래픽을 그대로 소화하기에는 다소 분리
  - 오류 없이 동작하는게 매우 중요 -> 성능보단 신뢰성

## 은행앱의 거래내역 조회
고객 -> 채널계 -> 계정계 -> 채널계 -> 고객

토스뱅크엔 기간 설정이 없음

카톡 라인 등등처럼 무한스크롤

- 채널계에 있는 송금 서버가 거래내역을 직접 반환 
- 코어뱅킹 서버와 항상 정확하게 동기화가 필요
  - 그렇다고 너무 동기화를 시도하면 부하가 커짐


- 유저가 이체를 실행할때마다 송금서버의 DB에 저장
  - 다른 은행앱에서 토스로 이체한 것은 조회되지 않음
  - 이런 경우엔 코어뱅킹 서버(계정계)가 입금이 되었다는 사실을 알려주어야 함 -> Kafka를 사용 

**예외 상황**
송금서버 -> 코어뱅킹 서버 타임아웃  
송금서버는 응답을 받지 못함, 거래내역을 DB에 저장하지 못함

이 문제도 kafka로 해결

송금이 완료되었을때 Kafka 토픽을 통해 이체 실행 결과를 알려줌.
송금서버가 거래내역을 송금 DB에 저장하고 유저에게 제공해줄 수 있음.

송금 직후엔 타임아웃으로 인한 에러

but 최종적으로 거래가 되고나면 결과를 받을 수 있음

-> 중복 이체

송금 서버는 코어뱅킹 서버에 송금요청을 보내기 전에 송금 DB에 저장.
완료되지 않은 송금 요청이 있는 유저가 다시 송금을 요청하면 거절.

나중에 송금이 완료되어 송금 서버가 송금 이력을 저장까지 끝내고 나면 그때부터 새로운 송금 요청을 수락

-> 송금이 영원히 지연될 수 있는 문제

네트워크 이슈로 송금서버에서 코어뱅킹 서버에 보낸 요청이 도달하지 못하는 경우 -> 영원히 송금을 할 수 없게 됨.

송금 서버는 주기적으로 코어뱅킹 서버에게 송금 요청의 상태를 확인.
송금 요청이 코어뱅킹 서버에 도달하지 못했으므로 코어 뱅킹 서버는 해당 송금 건에 대해 전혀 모름.
송금 서버는 송금 실패 처리.

**성공을 실패로 처리하는 경우**  
없다고 응답한 이후 송금 요청이 전달됨.

이 경우 타임아웃 시간을 약속해서 해결
타임아웃 시간이 지난 후 코어 뱅킹에 확인함 + 코어뱅킹 서버는 타임아웃이 지났으면 처리하지 않고 거절

### 거래 내역 동기화
만약 저장하는 도중 에러 발생으로 인한 실패 (ex: 순간적인 DB 장애)

이런 경우 송금 완료 메시지를 다시 컨슘하고 이력을 저장.
컨슈머 데드 레터라는 Kafka 토픽에 실패한 메시지를 저장하고, 개발자가 실패한 원인을 확인한 후, 해당 토픽을 다시 컨슘하여 송금을 처리

**송금 이력 누락**  
500원 입금 이후 100월 출금되는 상황

동기화 중 이슈가 발생해도 재동기화가 발생함으로 이슈 없음.

500원 동기화 실패, 100원 동기화 성공, 500원 동기화 재시도 이전에 고객이 조회 -> 총액이 -100원이 돼있음.

송금이 완료되었다는 메시지를 받으면 그 이전 다른 메시지가 있었는지 확인하여 동기화.
송금 서버에 저장된 가장 최근 거래 건과 kafka 거래 건의 id를 비교.

만약 500원 동기화가 또 실패하면? 100원 동기화도 revert.

동기화가 완료되기 전에 고객이 재시도한다면? 유저가 혼란.
송금 서버는 진행중인 거래 내역을 DB에 저장하는데
유저가 계좌의 거래내역을 조회할때 아직 진행 중인 거래가 있다면
그 즉시 계정계와 거래내역을 동기화

### 만약 한번에 백만건을 동기화해야한다면?
백반명의 토스 고객에게 한시간에 걸쳐 입금이 완료된다? 1초에 300건

코어 뱅킹 서버가 Kafka로 송금 서버에 입금을 알리면, 송금 서버는 하나씩 동기화.

kafka는 메시지를 여러 파티션으로 나눠서 여러 컨슈머가 처리할 수 있음.

유저가 지정한 key를 기준으로 파티션을 나눠줌. 예를 들어 같은 계좌를 같은 파티션에서 처리.

파티션을 무한정 늘릴 수는 없다. -> 시간이 걸리기 때문.

파티션 개수는 적당히 유지
컨슈머 별로 워커 스레드를 충분히 할당
파티션을 10개로 하고 컨슈머당 워커 스레드를 100개

동기화 작업을 실행할 워커 스레드를 선택할 때 같은 계좌는 같은 스레드가 동기화하도록 설정

### 최후의 수단
유저가 직접 동기화(불러오기)

### 요약
1. 빠른 거래내역 조회를 위해 채널계에 거래내역을 적재
2. 채널계에서 적재된 거래내역을 이용해 중복 송금 방지
3. 카프카를 이용해 계정계와 채널계 사이의 거래내역을 동기화
4. 만약의 경우 수동 동기화


